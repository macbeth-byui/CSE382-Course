<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 - Streams and Lazy Evaluation | Patterns in Functional Programming</title>
  <meta name="description" content="Design patterns and data structures common in functional programming. The text uses Erlang to demonstrate the material." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 - Streams and Lazy Evaluation | Patterns in Functional Programming" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Design patterns and data structures common in functional programming. The text uses Erlang to demonstrate the material." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 - Streams and Lazy Evaluation | Patterns in Functional Programming" />
  
  <meta name="twitter:description" content="Design patterns and data structures common in functional programming. The text uses Erlang to demonstrate the material." />
  

<meta name="author" content="Chad Macbeth" />


<meta name="date" content="2024-01-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="monoids-and-monads.html"/>
<link rel="next" href="trees.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Patterns in Functional Programming</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="erlang.html"><a href="erlang.html"><i class="fa fa-check"></i><b>1</b> Erlang</a>
<ul>
<li class="chapter" data-level="1.1" data-path="erlang.html"><a href="erlang.html#quick-erlang-primer"><i class="fa fa-check"></i><b>1.1</b> Quick Erlang Primer</a></li>
<li class="chapter" data-level="1.2" data-path="erlang.html"><a href="erlang.html#lists-in-erlang"><i class="fa fa-check"></i><b>1.2</b> Lists in Erlang</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="persistence.html"><a href="persistence.html"><i class="fa fa-check"></i><b>2</b> Persistence</a>
<ul>
<li class="chapter" data-level="2.1" data-path="persistence.html"><a href="persistence.html#persistence-in-lists"><i class="fa fa-check"></i><b>2.1</b> Persistence in Lists</a></li>
<li class="chapter" data-level="2.2" data-path="persistence.html"><a href="persistence.html#more-list-persistence"><i class="fa fa-check"></i><b>2.2</b> More List Persistence</a></li>
<li class="chapter" data-level="2.3" data-path="persistence.html"><a href="persistence.html#specifications-and-definitions"><i class="fa fa-check"></i><b>2.3</b> Specifications and Definitions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="higher-order-functions---map-and-filter.html"><a href="higher-order-functions---map-and-filter.html"><i class="fa fa-check"></i><b>3</b> Higher Order Functions - Map and Filter</a>
<ul>
<li class="chapter" data-level="3.1" data-path="higher-order-functions---map-and-filter.html"><a href="higher-order-functions---map-and-filter.html#map"><i class="fa fa-check"></i><b>3.1</b> Map</a></li>
<li class="chapter" data-level="3.2" data-path="higher-order-functions---map-and-filter.html"><a href="higher-order-functions---map-and-filter.html#filter"><i class="fa fa-check"></i><b>3.2</b> Filter</a></li>
<li class="chapter" data-level="3.3" data-path="higher-order-functions---map-and-filter.html"><a href="higher-order-functions---map-and-filter.html#functors"><i class="fa fa-check"></i><b>3.3</b> Functors</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="higher-order-functions---fold-and-unfold.html"><a href="higher-order-functions---fold-and-unfold.html"><i class="fa fa-check"></i><b>4</b> Higher Order Functions - Fold and Unfold</a>
<ul>
<li class="chapter" data-level="4.1" data-path="higher-order-functions---fold-and-unfold.html"><a href="higher-order-functions---fold-and-unfold.html#fold"><i class="fa fa-check"></i><b>4.1</b> Fold</a></li>
<li class="chapter" data-level="4.2" data-path="higher-order-functions---fold-and-unfold.html"><a href="higher-order-functions---fold-and-unfold.html#fold-right"><i class="fa fa-check"></i><b>4.2</b> Fold Right</a></li>
<li class="chapter" data-level="4.3" data-path="higher-order-functions---fold-and-unfold.html"><a href="higher-order-functions---fold-and-unfold.html#unfold"><i class="fa fa-check"></i><b>4.3</b> Unfold</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chaining-currying-and-partial-applications.html"><a href="chaining-currying-and-partial-applications.html"><i class="fa fa-check"></i><b>5</b> Chaining, Currying, and Partial Applications</a>
<ul>
<li class="chapter" data-level="5.1" data-path="chaining-currying-and-partial-applications.html"><a href="chaining-currying-and-partial-applications.html#chaining"><i class="fa fa-check"></i><b>5.1</b> Chaining</a></li>
<li class="chapter" data-level="5.2" data-path="chaining-currying-and-partial-applications.html"><a href="chaining-currying-and-partial-applications.html#currying"><i class="fa fa-check"></i><b>5.2</b> Currying</a></li>
<li class="chapter" data-level="5.3" data-path="chaining-currying-and-partial-applications.html"><a href="chaining-currying-and-partial-applications.html#partial-applications"><i class="fa fa-check"></i><b>5.3</b> Partial Applications</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="monoids-and-monads.html"><a href="monoids-and-monads.html"><i class="fa fa-check"></i><b>6</b> Monoids and Monads</a>
<ul>
<li class="chapter" data-level="6.1" data-path="monoids-and-monads.html"><a href="monoids-and-monads.html#monoids"><i class="fa fa-check"></i><b>6.1</b> Monoids</a></li>
<li class="chapter" data-level="6.2" data-path="monoids-and-monads.html"><a href="monoids-and-monads.html#monads"><i class="fa fa-check"></i><b>6.2</b> Monads</a></li>
<li class="chapter" data-level="6.3" data-path="monoids-and-monads.html"><a href="monoids-and-monads.html#list-monad"><i class="fa fa-check"></i><b>6.3</b> List Monad</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="streams-and-lazy-evaluation.html"><a href="streams-and-lazy-evaluation.html"><i class="fa fa-check"></i><b>7</b> Streams and Lazy Evaluation</a>
<ul>
<li class="chapter" data-level="7.1" data-path="streams-and-lazy-evaluation.html"><a href="streams-and-lazy-evaluation.html#streams"><i class="fa fa-check"></i><b>7.1</b> Streams</a></li>
<li class="chapter" data-level="7.2" data-path="streams-and-lazy-evaluation.html"><a href="streams-and-lazy-evaluation.html#stream-monad"><i class="fa fa-check"></i><b>7.2</b> Stream Monad</a></li>
<li class="chapter" data-level="7.3" data-path="streams-and-lazy-evaluation.html"><a href="streams-and-lazy-evaluation.html#erlang-processes-streams"><i class="fa fa-check"></i><b>7.3</b> Erlang Processes &amp; Streams</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="trees.html"><a href="trees.html"><i class="fa fa-check"></i><b>8</b> Trees</a>
<ul>
<li class="chapter" data-level="8.1" data-path="trees.html"><a href="trees.html#binary-search-tree"><i class="fa fa-check"></i><b>8.1</b> Binary Search Tree</a></li>
<li class="chapter" data-level="8.2" data-path="trees.html"><a href="trees.html#balanced-red-black-tree"><i class="fa fa-check"></i><b>8.2</b> Balanced Red-Black Tree</a></li>
<li class="chapter" data-level="8.3" data-path="trees.html"><a href="trees.html#performance"><i class="fa fa-check"></i><b>8.3</b> Performance</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="min-heaps.html"><a href="min-heaps.html"><i class="fa fa-check"></i><b>9</b> Min Heaps</a>
<ul>
<li class="chapter" data-level="9.1" data-path="min-heaps.html"><a href="min-heaps.html#min-heap"><i class="fa fa-check"></i><b>9.1</b> Min Heap</a></li>
<li class="chapter" data-level="9.2" data-path="min-heaps.html"><a href="min-heaps.html#efficient-inserting-and-removal"><i class="fa fa-check"></i><b>9.2</b> Efficient Inserting and Removal</a></li>
<li class="chapter" data-level="9.3" data-path="min-heaps.html"><a href="min-heaps.html#priority-queue"><i class="fa fa-check"></i><b>9.3</b> Priority Queue</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="random-access-lists.html"><a href="random-access-lists.html"><i class="fa fa-check"></i><b>10</b> Random Access Lists</a>
<ul>
<li class="chapter" data-level="10.1" data-path="random-access-lists.html"><a href="random-access-lists.html#binary-numbers-and-the-ral"><i class="fa fa-check"></i><b>10.1</b> Binary Numbers and the RAL</a></li>
<li class="chapter" data-level="10.2" data-path="random-access-lists.html"><a href="random-access-lists.html#lookup-and-update"><i class="fa fa-check"></i><b>10.2</b> Lookup and Update</a></li>
<li class="chapter" data-level="10.3" data-path="random-access-lists.html"><a href="random-access-lists.html#performance-1"><i class="fa fa-check"></i><b>10.3</b> Performance</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="tries.html"><a href="tries.html"><i class="fa fa-check"></i><b>11</b> Tries</a>
<ul>
<li class="chapter" data-level="11.1" data-path="tries.html"><a href="tries.html#creating-the-trie"><i class="fa fa-check"></i><b>11.1</b> Creating the Trie</a></li>
<li class="chapter" data-level="11.2" data-path="tries.html"><a href="tries.html#searching-and-counting"><i class="fa fa-check"></i><b>11.2</b> Searching and Counting</a></li>
<li class="chapter" data-level="11.3" data-path="tries.html"><a href="tries.html#performance-2"><i class="fa fa-check"></i><b>11.3</b> Performance</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="queues-and-deques.html"><a href="queues-and-deques.html"><i class="fa fa-check"></i><b>12</b> Queues and Deques</a>
<ul>
<li class="chapter" data-level="12.1" data-path="queues-and-deques.html"><a href="queues-and-deques.html#queues"><i class="fa fa-check"></i><b>12.1</b> Queues</a></li>
<li class="chapter" data-level="12.2" data-path="queues-and-deques.html"><a href="queues-and-deques.html#deques"><i class="fa fa-check"></i><b>12.2</b> Deques</a></li>
<li class="chapter" data-level="12.3" data-path="queues-and-deques.html"><a href="queues-and-deques.html#performance-3"><i class="fa fa-check"></i><b>12.3</b> Performance</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Patterns in Functional Programming</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="streams-and-lazy-evaluation" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7 -</span> Streams and Lazy Evaluation<a href="streams-and-lazy-evaluation.html#streams-and-lazy-evaluation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this lesson we will learn about the Stream Design Pattern. Streams are things that provide you values when you need them. They are very similair to the <code>unfold</code> function that we saw earlier. This “lazy” approach can actually save you a lot of time and memory when you only need something one at a time.</p>
<div id="streams" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Streams<a href="streams-and-lazy-evaluation.html#streams" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A stream provides information to us one item at a time whenever we need it. This implies that when writing a stream, we need to consider two things:</p>
<ul>
<li>The user needs to provide a function to call to evaluate the next item in the stream.</li>
<li>The function provided must be aware of the previous item.</li>
</ul>
<p>Let’s look at both of these needs separately. If we wanted to provide the user with the ability to add 1 to a number at any time, we could write a function that returns a function to be called later.</p>
<div class="formulabox">
<p><span class="math inline">\(spec ~ ~ lazy\_incr\_once :: integer \rightarrow (\lambda :: \rightarrow integer).\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ lazy\_incr\_once :: Value \rightarrow (\lambda :: \rightarrow Value + 1).\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb43-1"><a href="streams-and-lazy-evaluation.html#cb43-1" tabindex="-1"></a><span class="fu">lazy_incr_once(</span><span class="va">X</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="kw">fun</span><span class="fu">()</span> <span class="op">-&gt;</span> <span class="va">X</span> <span class="op">+</span> <span class="dv">1</span> <span class="kw">end</span><span class="fu">.</span></span>
<span id="cb43-2"><a href="streams-and-lazy-evaluation.html#cb43-2" tabindex="-1"></a></span>
<span id="cb43-3"><a href="streams-and-lazy-evaluation.html#cb43-3" tabindex="-1"></a><span class="fu">test()</span> <span class="op">-&gt;</span></span>
<span id="cb43-4"><a href="streams-and-lazy-evaluation.html#cb43-4" tabindex="-1"></a>    <span class="va">L</span> <span class="op">=</span> <span class="fu">lazy_incr_once(</span><span class="dv">4</span><span class="fu">),</span></span>
<span id="cb43-5"><a href="streams-and-lazy-evaluation.html#cb43-5" tabindex="-1"></a>    <span class="dv">5</span> <span class="op">=</span> <span class="va">L</span><span class="fu">(),</span></span>
<span id="cb43-6"><a href="streams-and-lazy-evaluation.html#cb43-6" tabindex="-1"></a>    <span class="dv">5</span> <span class="op">=</span> <span class="va">L</span><span class="fu">(),</span></span>
<span id="cb43-7"><a href="streams-and-lazy-evaluation.html#cb43-7" tabindex="-1"></a>    <span class="ch">ok</span><span class="fu">.</span></span></code></pre></div>
<p>In the code above, we are running the function that was returned when we called <code>lazy_incr_once</code>. It adds 1 to the original value 4 that was provided but never increases on subsequent calls. We now combine this with the desire to have the function return something based on the previous result. In the <code>lazy_incr</code> function, we will return two things: the next value and a brand new function to call to obtain the next value. Notice that we are defining a custom data type called <code>iterator</code> which will contain both of these things. Our ultimate goal by the next lesson is to define this as a Monad.</p>
<div class="formulabox">
<p><span class="math inline">\(struct ~ ~ iterator ~ ~ \lbrace a, \lambda_{stream} \rbrace.\)</span></p>
<p><span class="math inline">\(spec ~ ~ \lambda_{stream} :: \rightarrow iterator.\)</span></p>
<p><span class="math inline">\(spec ~ ~ lazy\_incr :: integer \rightarrow \lambda_{stream}.\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ lazy\_incr :: Value \rightarrow (\lambda_{stream} :: \rightarrow \lbrace (Value + 1), (lazy\_incr ~ ~ (Value + 1)) \rbrace).\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb44-1"><a href="streams-and-lazy-evaluation.html#cb44-1" tabindex="-1"></a><span class="fu">lazy_incr(</span><span class="va">Value</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="kw">fun</span><span class="fu">()</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">Value</span> <span class="op">+</span> <span class="dv">1</span><span class="fu">,</span> <span class="fu">lazy_incr(</span><span class="va">Value</span><span class="op">+</span><span class="dv">1</span><span class="fu">)}</span> <span class="kw">end</span><span class="fu">.</span></span>
<span id="cb44-2"><a href="streams-and-lazy-evaluation.html#cb44-2" tabindex="-1"></a></span>
<span id="cb44-3"><a href="streams-and-lazy-evaluation.html#cb44-3" tabindex="-1"></a><span class="fu">test()</span> <span class="op">-&gt;</span></span>
<span id="cb44-4"><a href="streams-and-lazy-evaluation.html#cb44-4" tabindex="-1"></a>    <span class="va">L</span> <span class="op">=</span> <span class="fu">lazy_incr(</span><span class="dv">4</span><span class="fu">),</span></span>
<span id="cb44-5"><a href="streams-and-lazy-evaluation.html#cb44-5" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">5</span><span class="fu">,</span> <span class="va">L2</span><span class="fu">}</span> <span class="op">=</span> <span class="va">L</span><span class="fu">(),</span></span>
<span id="cb44-6"><a href="streams-and-lazy-evaluation.html#cb44-6" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">6</span><span class="fu">,</span> <span class="va">L3</span><span class="fu">}</span> <span class="op">=</span> <span class="va">L2</span><span class="fu">(),</span></span>
<span id="cb44-7"><a href="streams-and-lazy-evaluation.html#cb44-7" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">7</span><span class="fu">,</span> <span class="va">L4</span><span class="fu">}</span> <span class="op">=</span> <span class="va">L3</span><span class="fu">(),</span></span>
<span id="cb44-8"><a href="streams-and-lazy-evaluation.html#cb44-8" tabindex="-1"></a>    <span class="ch">ok</span><span class="fu">.</span></span></code></pre></div>
<p>Another classic stream is the range function which will provide a sequence of numbers but only one at a time. In this function, we will assume that the sequence will go from <code>Start</code> to <code>Stop</code>, inclusive and that <code>Start &lt;= Stop</code>. Unlike the previous example, this iterator will need to stop. We will modify our new <code>fixed_iterator</code> to have other possible values.</p>
<div class="formulabox">
<p><span class="math inline">\(struct ~ ~ \mathit{f}ixed\_iterator\)</span></p>
<p><span class="math inline">\(\quad \quad \lbrace a, \lambda_{stream} \rbrace ~ ~ or\)</span></p>
<p><span class="math inline">\(\quad \quad \lbrace atom(unde\mathit{f}ined), atom(done) \rbrace.\)</span></p>
<p><span class="math inline">\(spec ~ ~ \lambda_{stream} :: \rightarrow \mathit{f}ixed\_iterator.\)</span></p>
<p><span class="math inline">\(spec ~ ~ range :: integer ~ ~ integer \rightarrow \lambda_{stream}.\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ range :: Start ~ ~ Stop \rightarrow (\lambda_{stream} :: \rightarrow \lbrace Start, (range ~ ~ (Start+1), Stop) \rbrace )\)</span></p>
<p><span class="math inline">\(\quad \quad \text{when} ~ ~ Start \leq Stop;\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ range :: Start ~ ~ Stop \rightarrow (\lambda_{stream} :: \rightarrow \lbrace undefined, done \rbrace).\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<p>The erlang code is given below:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb45-1"><a href="streams-and-lazy-evaluation.html#cb45-1" tabindex="-1"></a><span class="fu">range(</span><span class="va">Start</span><span class="fu">,</span> <span class="va">Stop</span><span class="fu">)</span> <span class="ch">when</span> <span class="va">Start</span> <span class="op">=&lt;</span> <span class="va">Stop</span> <span class="op">-&gt;</span></span>
<span id="cb45-2"><a href="streams-and-lazy-evaluation.html#cb45-2" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">()</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">Start</span><span class="fu">,</span> <span class="fu">range(</span><span class="va">Start</span><span class="op">+</span><span class="dv">1</span><span class="fu">,</span> <span class="va">Stop</span><span class="fu">)}</span> <span class="kw">end</span><span class="fu">;</span></span>
<span id="cb45-3"><a href="streams-and-lazy-evaluation.html#cb45-3" tabindex="-1"></a><span class="fu">range(</span><span class="va">_Start</span><span class="fu">,</span> <span class="va">_Stop</span><span class="fu">)</span> <span class="op">-&gt;</span></span>
<span id="cb45-4"><a href="streams-and-lazy-evaluation.html#cb45-4" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">()</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="ch">undefined</span><span class="fu">,</span> <span class="ch">done</span><span class="fu">}</span> <span class="kw">end</span><span class="fu">.</span></span></code></pre></div>
<p>We can simplify the above code by moving the guards into the anonymous function as shown below:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb46-1"><a href="streams-and-lazy-evaluation.html#cb46-1" tabindex="-1"></a><span class="fu">range(</span><span class="va">Start</span><span class="fu">,</span> <span class="va">Stop</span><span class="fu">)</span> <span class="op">-&gt;</span></span>
<span id="cb46-2"><a href="streams-and-lazy-evaluation.html#cb46-2" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">()</span> <span class="ch">when</span> <span class="va">Start</span> <span class="op">=&lt;</span> <span class="va">Stop</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="va">Start</span><span class="fu">,</span> <span class="fu">range(</span><span class="va">Start</span><span class="op">+</span><span class="dv">1</span><span class="fu">,</span> <span class="va">Stop</span><span class="fu">)};</span></span>
<span id="cb46-3"><a href="streams-and-lazy-evaluation.html#cb46-3" tabindex="-1"></a>        <span class="fu">()</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="ch">undefined</span><span class="fu">,</span> <span class="ch">done</span><span class="fu">}</span> <span class="kw">end</span><span class="fu">.</span></span></code></pre></div>
<p>An example of the test code using the <code>range</code> function is given below. Notice that the value of <code>{undefined, done}</code> is returned when the stream is completed.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb47-1"><a href="streams-and-lazy-evaluation.html#cb47-1" tabindex="-1"></a><span class="fu">test()</span> <span class="op">-&gt;</span></span>
<span id="cb47-2"><a href="streams-and-lazy-evaluation.html#cb47-2" tabindex="-1"></a>    <span class="va">Stream1</span> <span class="op">=</span> <span class="fu">range(</span><span class="dv">1</span><span class="fu">,</span><span class="dv">4</span><span class="fu">),</span></span>
<span id="cb47-3"><a href="streams-and-lazy-evaluation.html#cb47-3" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">1</span><span class="fu">,</span> <span class="va">Stream2</span><span class="fu">}</span> <span class="op">=</span> <span class="va">Stream1</span><span class="fu">(),</span></span>
<span id="cb47-4"><a href="streams-and-lazy-evaluation.html#cb47-4" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">2</span><span class="fu">,</span> <span class="va">Stream3</span><span class="fu">}</span> <span class="op">=</span> <span class="va">Stream2</span><span class="fu">(),</span></span>
<span id="cb47-5"><a href="streams-and-lazy-evaluation.html#cb47-5" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">3</span><span class="fu">,</span> <span class="va">Stream4</span><span class="fu">}</span> <span class="op">=</span> <span class="va">Stream3</span><span class="fu">(),</span></span>
<span id="cb47-6"><a href="streams-and-lazy-evaluation.html#cb47-6" tabindex="-1"></a>    <span class="fu">{</span><span class="dv">4</span><span class="fu">,</span> <span class="va">Stream5</span><span class="fu">}</span> <span class="op">=</span> <span class="va">Stream4</span><span class="fu">(),</span></span>
<span id="cb47-7"><a href="streams-and-lazy-evaluation.html#cb47-7" tabindex="-1"></a>    <span class="fu">{</span><span class="ch">undefined</span><span class="fu">,</span> <span class="ch">done</span><span class="fu">}</span> <span class="op">=</span> <span class="va">Stream5</span><span class="fu">(),</span></span>
<span id="cb47-8"><a href="streams-and-lazy-evaluation.html#cb47-8" tabindex="-1"></a>    <span class="ch">ok</span><span class="fu">.</span></span></code></pre></div>
<div class="problembox">
<p><strong>Problem Set 1</strong></p>
<p>You can find the template for the problem sets in this lesson here: <a href="proves/prove07.erl">prove07.erl</a></p>
<ol style="list-style-type: decimal">
<li>Modify the <code>range</code> function to take a third parameter called <code>Step</code>. You should increase the sequence by the amount of <code>Step</code>. If the <code>Step</code> is negative, then create a decreasing sequence. If the <code>Step</code> is 0, then the <code>done</code> state should occur immediately. Test code is provided to test your stream.</li>
<li>Create a new stream called <code>words</code> which will split text by spaces into sub-strings. Each time the stream is called, it should return back the next string. For example, if the text was “The cow jumped over the moon.”, then the stream would first return “The”, then “cow”, then “jumped”, and so forth. Use the same <code>fixed_iterator</code> type described above. You are provided a function called <code>first_word</code> which returns a tuple in the format <code>{Word, Rest}</code> where <code>Word</code> is the first word and <code>Rest</code> is the remaining text (just like working with values in a list). Test code is provided to test your stream.</li>
</ol>
</div>
</div>
<div id="stream-monad" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Stream Monad<a href="streams-and-lazy-evaluation.html#stream-monad" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In the previous section we created a <code>fixed_iterator</code> type that the <code>range</code> function supported. This type is actually a Monad. The <span class="math inline">\(\lambda_{stream}\)</span> provided in the <code>fixed_iterator</code> is the meta-data or state that we are maintaining for our stream. To complete the Monad definition, we need a type constructor (or unit function) and a bind function. Since the type constructor will need to create a stream that hasn’t started yet, we will modify our specification for the Monad Type we had earlier (the second condition in the struct is new):</p>
<div class="formulabox">
<p><span class="math inline">\(struct ~ ~ \mathit{f}ixed\_iterator\)</span></p>
<p><span class="math inline">\(\quad \quad \lbrace a, \lambda_{stream} \rbrace ~ ~ or\)</span></p>
<p><span class="math inline">\(\quad \quad \lbrace atom(unde\mathit{f}ined), \lambda_{stream} \rbrace ~ ~ or\)</span></p>
<p><span class="math inline">\(\quad \quad \lbrace atom(unde\mathit{f}ined), atom(done) \rbrace.\)</span></p>
<p><span class="math inline">\(spec ~ ~ \lambda_{stream} :: \rightarrow \mathit{f}ixed\_iterator.\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<p>The type constructor should be used to create the iterator the first time. We will call our type constructor <code>iter</code>. The <code>iter</code> will take as an input a <span class="math inline">\(\lambda_{stream}\)</span> function (the function that is returned by our <code>range</code> function or any other stream). The <code>iter</code> will produce the <span class="math inline">\(\lbrace atom(unde\mathit{f}ined), \lambda_{next} \rbrace\)</span>. This is the state of our iterator before we actually start the iteration.</p>
<div class="formulabox">
<p><span class="math inline">\(spec ~ ~ iter :: \lambda_{stream} \rightarrow \mathit{f}ixed\_iterator.\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ iter :: \lambda_{stream} \rightarrow \lbrace unde\mathit{f}ined, \lambda_{stream} \rbrace.\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<p>The bind should allow us to take our <code>fixed_iterator</code> (the Monad type returned by the <code>iter</code> function) and pass it to our stream function which will return an updated <code>fixed_iterator</code>. Remember that our stream function is always regenerated and has no input parameters. The next function is re-created each time with the next value built-into the function. We will call our bind function <code>next</code> and it will be responsible for getting the next stream iteration. Unlike previous bind functions we have used, this bind will not take a function parameter because we will limit the application of this bind function only to our <span class="math inline">\(\lambda_{stream}\)</span> function.</p>
<div class="formulabox">
<p><span class="math inline">\(spec ~ ~ next :: \mathit{f}ixed\_iterator \rightarrow \mathit{f}ixed\_iterator.\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ next :: \lbrace Value, done \rbrace \rightarrow \lbrace unde\mathit{f}ined, done \rbrace;\)</span></p>
<p><span class="math inline">\(de\mathit{f} ~ ~ next :: \lbrace Value, \lambda_{stream} \rbrace \rightarrow (\lambda_{stream}).\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<p>Using these specifications and definitions, we can complete the <code>fixed_iterator</code> Monad along with helper functions (<code>value</code> and <code>lambda</code>) to access both parts of our Monad type.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb48-1"><a href="streams-and-lazy-evaluation.html#cb48-1" tabindex="-1"></a><span class="fu">iter(</span><span class="va">Stream</span><span class="fu">)</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="ch">undefined</span><span class="fu">,</span> <span class="va">Stream</span><span class="fu">}.</span></span>
<span id="cb48-2"><a href="streams-and-lazy-evaluation.html#cb48-2" tabindex="-1"></a></span>
<span id="cb48-3"><a href="streams-and-lazy-evaluation.html#cb48-3" tabindex="-1"></a><span class="fu">next({</span><span class="va">_Value</span><span class="fu">,</span><span class="ch">done</span><span class="fu">})</span> <span class="op">-&gt;</span> <span class="fu">{</span><span class="ch">undefined</span><span class="fu">,</span> <span class="ch">done</span><span class="fu">};</span></span>
<span id="cb48-4"><a href="streams-and-lazy-evaluation.html#cb48-4" tabindex="-1"></a><span class="fu">next({</span><span class="va">_Value</span><span class="fu">,</span><span class="va">Lambda</span><span class="fu">})</span> <span class="op">-&gt;</span> <span class="va">Lambda</span><span class="fu">().</span></span>
<span id="cb48-5"><a href="streams-and-lazy-evaluation.html#cb48-5" tabindex="-1"></a></span>
<span id="cb48-6"><a href="streams-and-lazy-evaluation.html#cb48-6" tabindex="-1"></a><span class="fu">value({</span><span class="va">Value</span><span class="fu">,</span><span class="va">_Lambda</span><span class="fu">})</span> <span class="op">-&gt;</span> <span class="va">Value</span><span class="fu">.</span></span>
<span id="cb48-7"><a href="streams-and-lazy-evaluation.html#cb48-7" tabindex="-1"></a><span class="fu">lambda({</span><span class="va">_Value</span><span class="fu">,</span><span class="va">Lambda</span><span class="fu">})</span> <span class="op">-&gt;</span> <span class="va">Lambda</span><span class="fu">.</span></span></code></pre></div>
<p>We can use our new functions and show that calling our bind function <code>next</code> will result in <code>undefined</code> if we complete our iterator.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb49-1"><a href="streams-and-lazy-evaluation.html#cb49-1" tabindex="-1"></a><span class="va">Next1</span> <span class="op">=</span> <span class="fu">next(iter(range(</span><span class="dv">1</span><span class="fu">,</span><span class="dv">4</span><span class="fu">))),</span></span>
<span id="cb49-2"><a href="streams-and-lazy-evaluation.html#cb49-2" tabindex="-1"></a><span class="fu">io:format(</span><span class="st">&quot;~p~n&quot;</span><span class="fu">,[value(</span><span class="va">Next1</span><span class="fu">)]),</span>  <span class="co">% Print 1</span></span>
<span id="cb49-3"><a href="streams-and-lazy-evaluation.html#cb49-3" tabindex="-1"></a><span class="va">Next2</span> <span class="op">=</span> <span class="fu">next(</span><span class="va">Next1</span><span class="fu">),</span></span>
<span id="cb49-4"><a href="streams-and-lazy-evaluation.html#cb49-4" tabindex="-1"></a><span class="fu">io:format(</span><span class="st">&quot;~p~n&quot;</span><span class="fu">,[value(</span><span class="va">Next3</span><span class="fu">)]),</span>  <span class="co">% Print 2</span></span>
<span id="cb49-5"><a href="streams-and-lazy-evaluation.html#cb49-5" tabindex="-1"></a><span class="va">Next3</span> <span class="op">=</span> <span class="fu">next(</span><span class="va">Next2</span><span class="fu">),</span></span>
<span id="cb49-6"><a href="streams-and-lazy-evaluation.html#cb49-6" tabindex="-1"></a><span class="fu">io:format(</span><span class="st">&quot;~p~n&quot;</span><span class="fu">,[value(</span><span class="va">Next3</span><span class="fu">)]),</span>  <span class="co">% Print 3</span></span>
<span id="cb49-7"><a href="streams-and-lazy-evaluation.html#cb49-7" tabindex="-1"></a><span class="va">Next4</span> <span class="op">=</span> <span class="fu">next(</span><span class="va">Next3</span><span class="fu">),</span></span>
<span id="cb49-8"><a href="streams-and-lazy-evaluation.html#cb49-8" tabindex="-1"></a><span class="fu">io:format(</span><span class="st">&quot;~p~n&quot;</span><span class="fu">,[value(</span><span class="va">Next4</span><span class="fu">)]),</span>  <span class="co">% Print 4</span></span>
<span id="cb49-9"><a href="streams-and-lazy-evaluation.html#cb49-9" tabindex="-1"></a><span class="va">Next5</span> <span class="op">=</span> <span class="fu">next(</span><span class="va">Next4</span><span class="fu">),</span></span>
<span id="cb49-10"><a href="streams-and-lazy-evaluation.html#cb49-10" tabindex="-1"></a><span class="fu">io:format(</span><span class="st">&quot;~p~n&quot;</span><span class="fu">,[value(</span><span class="va">Next5</span><span class="fu">)]),</span>  <span class="co">% Print undefined</span></span>
<span id="cb49-11"><a href="streams-and-lazy-evaluation.html#cb49-11" tabindex="-1"></a><span class="va">Next6</span> <span class="op">=</span> <span class="fu">next(</span><span class="va">Next5</span><span class="fu">),</span></span>
<span id="cb49-12"><a href="streams-and-lazy-evaluation.html#cb49-12" tabindex="-1"></a><span class="fu">io:format(</span><span class="st">&quot;~p~n&quot;</span><span class="fu">,[value(</span><span class="va">Next6</span><span class="fu">)]),</span>  <span class="co">% Print undefined</span></span></code></pre></div>
<p>When we think about the <code>fixed_iterator</code> monad, we need to consider what the advantage is for using it. First, we could use it as means of looping through a list of values one at a time. This is not much different then creating a list and giving it to a recursive call. Perhaps we want to sum a lists of numbers. I could write the following code to sum the numbers 1 to 1000:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb50-1"><a href="streams-and-lazy-evaluation.html#cb50-1" tabindex="-1"></a><span class="dv">500500</span> <span class="op">=</span> <span class="fu">lists:sum(lists:seq(</span><span class="dv">1</span><span class="fu">,</span><span class="dv">1000</span><span class="fu">,</span><span class="dv">1</span><span class="fu">)).</span></span></code></pre></div>
<p>Assuming that we wrote a function <code>iter_sum</code> (specification below) which took in a <code>fixed_iterator</code> monad instead of a list, we could then write the following code to sum those same numbers 1 to 1000:</p>
<div class="formulabox">
<p><span class="math inline">\(spec ~ ~ iter\_sum :: \mathit{f}ixed\_iterator \rightarrow integer.\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb51-1"><a href="streams-and-lazy-evaluation.html#cb51-1" tabindex="-1"></a><span class="dv">500500</span> <span class="op">=</span> <span class="fu">iter_sum(iter(range(</span><span class="dv">1</span><span class="fu">,</span><span class="dv">1000</span><span class="fu">,</span><span class="dv">1</span><span class="fu">))).</span></span></code></pre></div>
<p>If we run both of these, we will see not much difference. However, what if we summed the numbers from 1 to 500,000,000? Consider the work that must be done. If the first example, the <code>lists:seq</code> function will create the list first which is an <span class="math inline">\(O(n)\)</span> operation and we take up a lot of memory. After it creates the list, it then needs loop through the list again recursively to add up the values. The is another <span class="math inline">\(O(n)\)</span> operation.</p>
<p>In the second example, the <code>iter</code> and <code>range</code> functions do not create any list. This is <span class="math inline">\(O(1)\)</span>. The <code>iter_sum</code> will loop recursively on the stream until we get to <code>{undefined,done}</code>. This will be <span class="math inline">\(O(n)\)</span>. Note that there is no data structure involved. Removing the overhead will drastically reduce the time it takes. In the problem set, you will observe the actual time difference.</p>
<p>In other languages like Haskell, there is built-in support for lazy functions. In Erlang we have to create the additional functions like <code>iter</code> and <code>iter_sum</code>. It may seem like extra work, but imagine if our lazy function was to read the next line of very large file or dataset, the next value in a list that has no pre-defined end, or the next page of results from an API. Instead of loading everything up (or generating our list of numbers) first, we can write a stream function to give us the next thing. The stream is nothing more than a function without parameters that has the current state contained in that function.</p>
<div class="problembox">
<p><strong>Problem Set 2</strong></p>
<ol style="list-style-type: decimal">
<li>Implement the <code>iter_sum</code> function to recursively add up all the values in the <code>fixed_iterator</code> stream created with <code>iter(range(1,500000000,1))</code>. The test code already calls the <code>iter_sum</code> function. It may take a few minutes to run the code. The sum should be 125,000,000,250,000,000. You can reduce the number down to 10 for testing purposes and the change it back to 500,000,000 when your <code>iter_sum</code> is working.</li>
<li>The test code will display the current time as <code>{hour,minutes,seconds}</code>. Describe in the comments what you observed when comparing the <code>lists:sum</code> and the <code>iter_sum</code> functions.</li>
</ol>
</div>
</div>
<div id="erlang-processes-streams" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Erlang Processes &amp; Streams<a href="streams-and-lazy-evaluation.html#erlang-processes-streams" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Another common problem solved with streams is a unique ID generator. We could write the same code above to obtain a function that will return the next available number (i.e. prev number + 1). However, if we had multiple software components that needed to use the same unique ID generator, then we need a slightly different approach.</p>
<p>Erlang supports a scalable process system that allows for safe concurrent operations. This process system can be used locally with our software or it can be used along with networking code to support communication between different machines.</p>
<p>The diagram below shows how a client/server process architecture can be setup in Erlang. We will assume in our discussion that both the client and the server are running locally on our same machine.</p>
<p><img src="images/client_server_erlang.drawio.png" /></p>
<p>In the diagram above, we have a process that is started (or spawned) by <code>start_server</code> and handles messages received by <code>handle_server</code>. The client uses the server process ID (PID) to send messages to the server and then waits for a response. All messages sent to the server are formatted as follows:</p>
<div class="formulabox">
<p><span class="math inline">\(\lbrace Client\_PID, Command, \lbrace Parameters \rbrace \rbrace\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<p>Responses back to the client are formatted as follows:</p>
<div class="formulabox">
<p><span class="math inline">\(\lbrace Response \rbrace\)</span></p>
</div>
<p><span class="math inline">\(\nonumber\)</span></p>
<p>This simple server has only two commands:</p>
<ul>
<li>echo - Send the text back to the client</li>
<li>add - Add the two numbers and send back the answer to the client.</li>
</ul>
<p>The server can handle only one request at a time. After the server handles the request, the <code>handle_server</code> function is called again to handle the next request. This ability to handle only one thing at a time will help us create the unique ID server later on. Let’s first look at the Erlang code needed:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb52-1"><a href="streams-and-lazy-evaluation.html#cb52-1" tabindex="-1"></a><span class="fu">handle_server()</span> <span class="op">-&gt;</span></span>
<span id="cb52-2"><a href="streams-and-lazy-evaluation.html#cb52-2" tabindex="-1"></a>    <span class="kw">receive</span></span>
<span id="cb52-3"><a href="streams-and-lazy-evaluation.html#cb52-3" tabindex="-1"></a>        <span class="fu">{</span><span class="va">Client_PID</span><span class="fu">,</span> <span class="ch">echo</span><span class="fu">,</span> <span class="fu">{</span><span class="va">Text</span><span class="fu">}}</span> <span class="op">-&gt;</span> <span class="va">Client_PID</span> <span class="op">!</span> <span class="fu">{</span><span class="va">Text</span><span class="fu">};</span></span>
<span id="cb52-4"><a href="streams-and-lazy-evaluation.html#cb52-4" tabindex="-1"></a>        <span class="fu">{</span><span class="va">Client_PID</span><span class="fu">,</span> <span class="ch">add</span><span class="fu">,</span> <span class="fu">{</span><span class="va">X</span><span class="fu">,</span> <span class="va">Y</span><span class="fu">}}</span> <span class="op">-&gt;</span> <span class="va">Client_PID</span> <span class="op">!</span> <span class="fu">{</span><span class="va">X</span><span class="op">+</span><span class="va">Y</span><span class="fu">}</span></span>
<span id="cb52-5"><a href="streams-and-lazy-evaluation.html#cb52-5" tabindex="-1"></a>    <span class="kw">end</span><span class="fu">,</span></span>
<span id="cb52-6"><a href="streams-and-lazy-evaluation.html#cb52-6" tabindex="-1"></a>    <span class="fu">handle_server().</span></span>
<span id="cb52-7"><a href="streams-and-lazy-evaluation.html#cb52-7" tabindex="-1"></a></span>
<span id="cb52-8"><a href="streams-and-lazy-evaluation.html#cb52-8" tabindex="-1"></a><span class="fu">start_server()</span> <span class="op">-&gt;</span></span>
<span id="cb52-9"><a href="streams-and-lazy-evaluation.html#cb52-9" tabindex="-1"></a>    <span class="fu">spawn(</span><span class="ch">prove07</span><span class="fu">,</span> <span class="ch">handle_server</span><span class="fu">,</span> <span class="fu">[]).</span></span>
<span id="cb52-10"><a href="streams-and-lazy-evaluation.html#cb52-10" tabindex="-1"></a> </span>
<span id="cb52-11"><a href="streams-and-lazy-evaluation.html#cb52-11" tabindex="-1"></a><span class="fu">send_to_server(</span><span class="va">Server_PID</span><span class="fu">,</span> <span class="va">Command</span><span class="fu">,</span> <span class="va">Params</span><span class="fu">)</span> <span class="op">-&gt;</span></span>
<span id="cb52-12"><a href="streams-and-lazy-evaluation.html#cb52-12" tabindex="-1"></a>    <span class="va">Server_PID</span> <span class="op">!</span> <span class="fu">{self(),</span> <span class="va">Command</span><span class="fu">,</span> <span class="va">Params</span><span class="fu">},</span></span>
<span id="cb52-13"><a href="streams-and-lazy-evaluation.html#cb52-13" tabindex="-1"></a>    <span class="kw">receive</span></span>
<span id="cb52-14"><a href="streams-and-lazy-evaluation.html#cb52-14" tabindex="-1"></a>        <span class="fu">{</span><span class="va">Response</span><span class="fu">}</span> <span class="op">-&gt;</span> <span class="va">Response</span></span>
<span id="cb52-15"><a href="streams-and-lazy-evaluation.html#cb52-15" tabindex="-1"></a>    <span class="kw">end</span><span class="fu">.</span></span></code></pre></div>
<p>The <code>start_server</code> function will spawn a new process. When spawning a new process, the handler function is specified along with its module name and a list of any parameters. In this simple example, there are no parameters. Note that you have to export the <code>handle_server</code> function for the <code>spawn</code> function to work properly.</p>
<p>The <code>handle_server</code> function uses the <code>receive</code> command to receive a message from a client. When one is received and matches one of the patterns in the <code>receive</code> command block, then a response is sent back. In Erlang, a message is sent using the syntax: <code>PID ! Message</code>. We use the Client PID that we received to send the response back. The call to <code>handle_server</code> recursively at the end will allow the server to response to the next client.</p>
<p>The <code>send_to_server</code> function is a utility function to help us send a message to server and receive the response. When sending messages to the server, the Erlang function <code>self()</code> is called to obtain the client PID to send to the server. A test example is shown below:</p>
<pre class="shell"><code>2&gt; Server_PID = prove07:start_server().
&lt;0.85.0&gt;
3&gt; prove07:send_to_server(Server_PID, echo, {&quot;Hello&quot;}).
&quot;Hello&quot;
4&gt; prove07:send_to_server(Server_PID, add, {13, 8}).    
21
5&gt;</code></pre>
<p>If we wanted to create a unique ID server following this same format, we can modify our handler function to take a parameter that keeps track of the current ID. Remember that each call to the handler function is guaranteed to handle only one client at a time. Similar to the concept of the stream functions being created with the next value in the stream, our handler will create the next value to be used.</p>
<p>Here is the code for our new <code>start_id_server</code> and <code>handle_id_server</code>. Notice that the <code>handle_id_server</code> now has an input parameter and it is initialized in the spawn function within <code>start_id_server</code>. For the <code>export</code>, notice that we specify the arity: <code>handle_id_server/1</code>.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode erlang"><code class="sourceCode erlang"><span id="cb54-1"><a href="streams-and-lazy-evaluation.html#cb54-1" tabindex="-1"></a><span class="kw">-export</span><span class="fu">([</span><span class="ch">handle_id_server</span><span class="op">/</span><span class="dv">1</span><span class="fu">]).</span></span>
<span id="cb54-2"><a href="streams-and-lazy-evaluation.html#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="streams-and-lazy-evaluation.html#cb54-3" tabindex="-1"></a><span class="fu">handle_id_server(</span><span class="va">Curr_ID</span><span class="fu">)</span> <span class="op">-&gt;</span></span>
<span id="cb54-4"><a href="streams-and-lazy-evaluation.html#cb54-4" tabindex="-1"></a>    <span class="kw">receive</span></span>
<span id="cb54-5"><a href="streams-and-lazy-evaluation.html#cb54-5" tabindex="-1"></a>        <span class="fu">{</span><span class="va">Client_PID</span><span class="fu">,</span> <span class="ch">id</span><span class="fu">,</span> <span class="fu">{}}</span> <span class="op">-&gt;</span> <span class="va">Client_PID</span> <span class="op">!</span> <span class="fu">{</span><span class="va">Curr_ID</span><span class="fu">}</span></span>
<span id="cb54-6"><a href="streams-and-lazy-evaluation.html#cb54-6" tabindex="-1"></a>    <span class="kw">end</span><span class="fu">,</span></span>
<span id="cb54-7"><a href="streams-and-lazy-evaluation.html#cb54-7" tabindex="-1"></a>    <span class="fu">handle_id_server(</span><span class="va">Curr_ID</span> <span class="op">+</span> <span class="dv">1</span><span class="fu">).</span></span>
<span id="cb54-8"><a href="streams-and-lazy-evaluation.html#cb54-8" tabindex="-1"></a></span>
<span id="cb54-9"><a href="streams-and-lazy-evaluation.html#cb54-9" tabindex="-1"></a><span class="fu">start_id_server()</span> <span class="op">-&gt;</span></span>
<span id="cb54-10"><a href="streams-and-lazy-evaluation.html#cb54-10" tabindex="-1"></a>    <span class="fu">spawn(</span><span class="ch">prove07</span><span class="fu">,</span> <span class="ch">handle_id_server</span><span class="fu">,</span> <span class="fu">[</span><span class="dv">0</span><span class="fu">]).</span></span></code></pre></div>
<p>When the <code>handle_id_server</code> is called recursively to handle the request from the next client, the <code>Unique_ID</code> is incremented by 1.</p>
<p>Reusing the same <code>send_to_server</code> function, we can generate new unique ID’s as follows starting with 0.</p>
<pre class="shell"><code>5&gt; ID_Server_PID = prove07:start_id_server(). 
&lt;0.89.0&gt;
6&gt; prove07:send_to_server(ID_Server_PID, id, {}).       
0
7&gt; prove07:send_to_server(ID_Server_PID, id, {}).
1
8&gt; prove07:send_to_server(ID_Server_PID, id, {}).
2
9&gt; prove07:send_to_server(ID_Server_PID, id, {}).
3
10&gt; prove07:send_to_server(ID_Server_PID, id, {}).
4
11&gt; prove07:send_to_server(ID_Server_PID, id, {}).
5
12&gt; </code></pre>
<div class="problembox">
<p><strong>Problem Set 3</strong></p>
<ol style="list-style-type: decimal">
<li>Modify the <code>handle_server</code> function to support an <code>avg</code> command that will average a variable collection of numbers. For example, if the parameters field is <code>{10,20,30,40}</code> then 25 will be returned back to the client. You can use the Erlang <code>lists:sum</code> and <code>length</code> functions.</li>
<li>Create a server based on the Unique ID server but with functions called <code>handle_running_avg_server</code> (remember that this one needs to be exported) and <code>start_running_avg_server</code> that maintains a running average of numbers submitted. There should be three commands:
<ul>
<li>add - Adds a number to the running average and returns the current average</li>
<li>remove - Removes a number from the running average and returns the current average</li>
<li>display - Returns the current average</li>
</ul>
When implementing the running average server, you should save the current sum and current number of numbers in your server. You should not store the list of numbers. Additionally, you don’t have to consider error scenarios that would lead to divide by 0. Test code is provided for you.</li>
</ol>
</div>
<p><span class="math inline">\(\nonumber\)</span>
<span class="math inline">\(\nonumber\)</span>
<a href="http://creativecommons.org/licenses/by/4.0/"><img src="images/cc-88x31.png" alt="Creative Commons License - CC - BY" /></a></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="monoids-and-monads.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="trees.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": {},
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
